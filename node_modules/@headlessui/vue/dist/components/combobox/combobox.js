import{Fragment as G,computed as g,defineComponent as A,h as U,inject as Q,nextTick as E,onMounted as W,onUnmounted as X,provide as Y,ref as w,toRaw as b,watch as q,watchEffect as K}from"vue";import{Features as N,render as F,omit as $,compact as Z}from'../../utils/render.js';import{useId as j}from'../../hooks/use-id.js';import{Keys as I}from'../../keyboard.js';import{calculateActiveIndex as z,Focus as T}from'../../utils/calculate-active-index.js';import{dom as P}from'../../utils/dom.js';import{useOpenClosed as ee,State as _,useOpenClosedProvider as te}from'../../internal/open-closed.js';import{match as M}from'../../utils/match.js';import{useResolveButtonType as oe}from'../../hooks/use-resolve-button-type.js';import{useTreeWalker as ne}from'../../hooks/use-tree-walker.js';import{sortByDomNode as ae}from'../../utils/focus-management.js';import{useOutsideClick as le}from'../../hooks/use-outside-click.js';import{Hidden as ie,Features as ue}from'../../internal/hidden.js';import{objectToFormEntries as re}from'../../utils/form.js';import{useControllable as se}from'../../hooks/use-controllable.js';function de(n,m){return n===m}var pe=(i=>(i[i.Open=0]="Open",i[i.Closed=1]="Closed",i))(pe||{}),be=(i=>(i[i.Single=0]="Single",i[i.Multi=1]="Multi",i))(be||{}),fe=(i=>(i[i.Pointer=0]="Pointer",i[i.Other=1]="Other",i))(fe||{});let J=Symbol("ComboboxContext");function L(n){let m=Q(J,null);if(m===null){let i=new Error(`<${n} /> is missing a parent <Combobox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(i,L),i}return m}let Ae=A({name:"Combobox",emits:{"update:modelValue":n=>!0},props:{as:{type:[Object,String],default:"template"},disabled:{type:[Boolean],default:!1},by:{type:[String,Function],default:()=>de},modelValue:{type:[Object,String,Number,Boolean],default:void 0},defaultValue:{type:[Object,String,Number,Boolean],default:void 0},name:{type:String},nullable:{type:Boolean,default:!1},multiple:{type:[Boolean],default:!1}},inheritAttrs:!1,setup(n,{slots:m,attrs:i,emit:y}){let e=w(1),t=w(null),c=w(null),S=w(null),x=w(null),v=w({static:!1,hold:!1}),l=w([]),C=w(null),R=w(1),o=w(!1);function s(a=d=>d){let d=C.value!==null?l.value[C.value]:null,r=ae(a(l.value.slice()),f=>P(f.dataRef.domRef)),u=d?r.indexOf(d):null;return u===-1&&(u=null),{options:r,activeOptionIndex:u}}let O=g(()=>n.multiple?1:0),k=g(()=>n.nullable),[D,V]=se(g(()=>n.modelValue),a=>y("update:modelValue",a),g(()=>n.defaultValue)),p={comboboxState:e,value:D,mode:O,compare(a,d){if(typeof n.by=="string"){let r=n.by;return(a==null?void 0:a[r])===(d==null?void 0:d[r])}return n.by(a,d)},nullable:k,inputRef:c,labelRef:t,buttonRef:S,optionsRef:x,disabled:g(()=>n.disabled),options:l,change(a){V(a)},activeOptionIndex:g(()=>{if(o.value&&C.value===null&&l.value.length>0){let a=l.value.findIndex(d=>!d.dataRef.disabled);if(a!==-1)return a}return C.value}),activationTrigger:R,optionsPropsRef:v,closeCombobox(){o.value=!1,!n.disabled&&e.value!==1&&(e.value=1,C.value=null)},openCombobox(){if(o.value=!0,n.disabled||e.value===0)return;let a=l.value.findIndex(d=>{let r=b(d.dataRef.value);return M(O.value,{[0]:()=>p.compare(b(p.value.value),b(r)),[1]:()=>b(p.value.value).some(f=>p.compare(b(f),b(r)))})});a!==-1&&(C.value=a),e.value=0},goToOption(a,d,r){if(o.value=!1,n.disabled||x.value&&!v.value.static&&e.value===1)return;let u=s();if(u.activeOptionIndex===null){let h=u.options.findIndex(B=>!B.dataRef.disabled);h!==-1&&(u.activeOptionIndex=h)}let f=z(a===T.Specific?{focus:T.Specific,id:d}:{focus:a},{resolveItems:()=>u.options,resolveActiveIndex:()=>u.activeOptionIndex,resolveId:h=>h.id,resolveDisabled:h=>h.dataRef.disabled});C.value=f,R.value=r!=null?r:1,l.value=u.options},selectOption(a){let d=l.value.find(u=>u.id===a);if(!d)return;let{dataRef:r}=d;V(M(O.value,{[0]:()=>r.value,[1]:()=>{let u=b(p.value.value).slice(),f=b(r.value),h=u.findIndex(B=>p.compare(f,b(B)));return h===-1?u.push(f):u.splice(h,1),u}}))},selectActiveOption(){if(p.activeOptionIndex.value===null)return;let{dataRef:a,id:d}=l.value[p.activeOptionIndex.value];V(M(O.value,{[0]:()=>a.value,[1]:()=>{let r=b(p.value.value).slice(),u=b(a.value),f=r.findIndex(h=>p.compare(u,b(h)));return f===-1?r.push(u):r.splice(f,1),r}})),p.goToOption(T.Specific,d)},registerOption(a,d){let r={id:a,dataRef:d},u=s(f=>[...f,r]);if(C.value===null){let f=d.value.value;M(O.value,{[0]:()=>p.compare(b(p.value.value),b(f)),[1]:()=>b(p.value.value).some(B=>p.compare(b(B),b(f)))})&&(u.activeOptionIndex=u.options.indexOf(r))}l.value=u.options,C.value=u.activeOptionIndex,R.value=1},unregisterOption(a){let d=s(r=>{let u=r.findIndex(f=>f.id===a);return u!==-1&&r.splice(u,1),r});l.value=d.options,C.value=d.activeOptionIndex,R.value=1}};le([c,S,x],()=>p.closeCombobox(),g(()=>e.value===0)),Y(J,p),te(g(()=>M(e.value,{[0]:_.Open,[1]:_.Closed})));let H=g(()=>p.activeOptionIndex.value===null?null:l.value[p.activeOptionIndex.value].dataRef.value);return()=>{let{name:a,disabled:d,...r}=n,u={open:e.value===0,disabled:d,activeIndex:p.activeOptionIndex.value,activeOption:H.value,value:D.value};return U(G,[...a!=null&&D.value!=null?re({[a]:D.value}).map(([f,h])=>U(ie,Z({features:ue.Hidden,key:f,as:"input",type:"hidden",hidden:!0,readOnly:!0,name:f,value:h}))):[],F({theirProps:{...i,...$(r,["modelValue","defaultValue","nullable","multiple","onUpdate:modelValue","by"])},ourProps:{},slot:u,slots:m,attrs:i,name:"Combobox"})])}}}),Fe=A({name:"ComboboxLabel",props:{as:{type:[Object,String],default:"label"}},setup(n,{attrs:m,slots:i}){let y=L("ComboboxLabel"),e=`headlessui-combobox-label-${j()}`;function t(){var c;(c=P(y.inputRef))==null||c.focus({preventScroll:!0})}return()=>{let c={open:y.comboboxState.value===0,disabled:y.disabled.value},S={id:e,ref:y.labelRef,onClick:t};return F({ourProps:S,theirProps:n,slot:c,attrs:m,slots:i,name:"ComboboxLabel"})}}}),Le=A({name:"ComboboxButton",props:{as:{type:[Object,String],default:"button"}},setup(n,{attrs:m,slots:i,expose:y}){let e=L("ComboboxButton"),t=`headlessui-combobox-button-${j()}`;y({el:e.buttonRef,$el:e.buttonRef});function c(v){e.disabled.value||(e.comboboxState.value===0?e.closeCombobox():(v.preventDefault(),e.openCombobox()),E(()=>{var l;return(l=P(e.inputRef))==null?void 0:l.focus({preventScroll:!0})}))}function S(v){switch(v.key){case I.ArrowDown:v.preventDefault(),v.stopPropagation(),e.comboboxState.value===1&&e.openCombobox(),E(()=>{var l;return(l=e.inputRef.value)==null?void 0:l.focus({preventScroll:!0})});return;case I.ArrowUp:v.preventDefault(),v.stopPropagation(),e.comboboxState.value===1&&(e.openCombobox(),E(()=>{e.value.value||e.goToOption(T.Last)})),E(()=>{var l;return(l=e.inputRef.value)==null?void 0:l.focus({preventScroll:!0})});return;case I.Escape:if(e.comboboxState.value!==0)return;v.preventDefault(),e.optionsRef.value&&!e.optionsPropsRef.value.static&&v.stopPropagation(),e.closeCombobox(),E(()=>{var l;return(l=e.inputRef.value)==null?void 0:l.focus({preventScroll:!0})});return}}let x=oe(g(()=>({as:n.as,type:m.type})),e.buttonRef);return()=>{var R,o;let v={open:e.comboboxState.value===0,disabled:e.disabled.value,value:e.value.value},l={ref:e.buttonRef,id:t,type:x.value,tabindex:"-1","aria-haspopup":!0,"aria-controls":(R=P(e.optionsRef))==null?void 0:R.id,"aria-expanded":e.disabled.value?void 0:e.comboboxState.value===0,"aria-labelledby":e.labelRef.value?[(o=P(e.labelRef))==null?void 0:o.id,t].join(" "):void 0,disabled:e.disabled.value===!0?!0:void 0,onKeydown:S,onClick:c};return F({ourProps:l,theirProps:n,slot:v,attrs:m,slots:i,name:"ComboboxButton"})}}}),Be=A({name:"ComboboxInput",props:{as:{type:[Object,String],default:"input"},static:{type:Boolean,default:!1},unmount:{type:Boolean,default:!0},displayValue:{type:Function}},emits:{change:n=>!0},setup(n,{emit:m,attrs:i,slots:y,expose:e}){let t=L("ComboboxInput"),c=`headlessui-combobox-input-${j()}`;e({el:t.inputRef,$el:t.inputRef});let S=w(t.value.value),x=()=>{var s;let o=t.value.value;return P(t.inputRef)?typeof n.displayValue!="undefined"?(s=n.displayValue(o))!=null?s:"":typeof o=="string"?o:"":""};const v=w("");W(()=>{q([t.value,v],()=>{S.value=x()},{flush:"sync",immediate:!0}),q([S,t.comboboxState],([o,s],[O,k])=>{let D=P(t.inputRef);!D||(k===0&&s===1||o!==O)&&(D.value=o)},{immediate:!0})});function l(o){switch(o.key){case I.Backspace:case I.Delete:if(t.mode.value!==0||!t.nullable.value)return;let s=o.currentTarget;requestAnimationFrame(()=>{if(s.value===""){t.change(null);let O=P(t.optionsRef);O&&(O.scrollTop=0),t.goToOption(T.Nothing)}});break;case I.Enter:if(t.comboboxState.value!==0||o.isComposing)return;if(o.preventDefault(),o.stopPropagation(),t.activeOptionIndex.value===null){t.closeCombobox();return}t.selectActiveOption(),t.mode.value===0&&t.closeCombobox();break;case I.ArrowDown:return o.preventDefault(),o.stopPropagation(),M(t.comboboxState.value,{[0]:()=>t.goToOption(T.Next),[1]:()=>t.openCombobox()});case I.ArrowUp:return o.preventDefault(),o.stopPropagation(),M(t.comboboxState.value,{[0]:()=>t.goToOption(T.Previous),[1]:()=>{t.openCombobox(),E(()=>{t.value.value||t.goToOption(T.Last)})}});case I.Home:case I.PageUp:return o.preventDefault(),o.stopPropagation(),t.goToOption(T.First);case I.End:case I.PageDown:return o.preventDefault(),o.stopPropagation(),t.goToOption(T.Last);case I.Escape:if(t.comboboxState.value!==0)return;o.preventDefault(),t.optionsRef.value&&!t.optionsPropsRef.value.static&&o.stopPropagation(),t.closeCombobox();break;case I.Tab:if(t.comboboxState.value!==0)return;t.mode.value===0&&t.selectActiveOption(),t.closeCombobox();break}}function C(o){m("change",o)}function R(o){t.openCombobox(),m("change",o)}return()=>{var k,D,V,p,H,a;let o={open:t.comboboxState.value===0},s={"aria-controls":(k=t.optionsRef.value)==null?void 0:k.id,"aria-expanded":t.disabled.value?void 0:t.comboboxState.value===0,"aria-activedescendant":t.activeOptionIndex.value===null||(D=t.options.value[t.activeOptionIndex.value])==null?void 0:D.id,"aria-multiselectable":t.mode.value===1?!0:void 0,"aria-labelledby":(H=(V=P(t.labelRef))==null?void 0:V.id)!=null?H:(p=P(t.buttonRef))==null?void 0:p.id,id:c,onKeydown:l,onChange:C,onInput:R,role:"combobox",type:(a=i.type)!=null?a:"text",tabIndex:0,ref:t.inputRef},O=$(n,["displayValue"]);return F({ourProps:s,theirProps:O,slot:o,attrs:i,slots:y,features:N.RenderStrategy|N.Static,name:"ComboboxInput"})}}}),je=A({name:"ComboboxOptions",props:{as:{type:[Object,String],default:"ul"},static:{type:Boolean,default:!1},unmount:{type:Boolean,default:!0},hold:{type:[Boolean],default:!1}},setup(n,{attrs:m,slots:i,expose:y}){let e=L("ComboboxOptions"),t=`headlessui-combobox-options-${j()}`;y({el:e.optionsRef,$el:e.optionsRef}),K(()=>{e.optionsPropsRef.value.static=n.static}),K(()=>{e.optionsPropsRef.value.hold=n.hold});let c=ee(),S=g(()=>c!==null?c.value===_.Open:e.comboboxState.value===0);return ne({container:g(()=>P(e.optionsRef)),enabled:g(()=>e.comboboxState.value===0),accept(x){return x.getAttribute("role")==="option"?NodeFilter.FILTER_REJECT:x.hasAttribute("role")?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT},walk(x){x.setAttribute("role","none")}}),()=>{var C,R,o,s;let x={open:e.comboboxState.value===0},v={"aria-activedescendant":e.activeOptionIndex.value===null||(C=e.options.value[e.activeOptionIndex.value])==null?void 0:C.id,"aria-labelledby":(s=(R=P(e.labelRef))==null?void 0:R.id)!=null?s:(o=P(e.buttonRef))==null?void 0:o.id,id:t,ref:e.optionsRef,role:"listbox"},l=$(n,["hold"]);return F({ourProps:v,theirProps:l,slot:x,attrs:m,slots:i,features:N.RenderStrategy|N.Static,visible:S.value,name:"ComboboxOptions"})}}}),He=A({name:"ComboboxOption",props:{as:{type:[Object,String],default:"li"},value:{type:[Object,String,Number,Boolean]},disabled:{type:Boolean,default:!1}},setup(n,{slots:m,attrs:i,expose:y}){let e=L("ComboboxOption"),t=`headlessui-combobox-option-${j()}`,c=w(null);y({el:c,$el:c});let S=g(()=>e.activeOptionIndex.value!==null?e.options.value[e.activeOptionIndex.value].id===t:!1),x=g(()=>M(e.mode.value,{[0]:()=>e.compare(b(e.value.value),b(n.value)),[1]:()=>b(e.value.value).some(s=>e.compare(b(s),b(n.value)))})),v=g(()=>({disabled:n.disabled,value:n.value,domRef:c}));W(()=>e.registerOption(t,v)),X(()=>e.unregisterOption(t)),K(()=>{e.comboboxState.value===0&&(!S.value||e.activationTrigger.value!==0&&E(()=>{var s,O;return(O=(s=P(c))==null?void 0:s.scrollIntoView)==null?void 0:O.call(s,{block:"nearest"})}))});function l(s){if(n.disabled)return s.preventDefault();e.selectOption(t),e.mode.value===0&&e.closeCombobox()}function C(){if(n.disabled)return e.goToOption(T.Nothing);e.goToOption(T.Specific,t)}function R(){n.disabled||S.value||e.goToOption(T.Specific,t,0)}function o(){n.disabled||!S.value||e.optionsPropsRef.value.hold||e.goToOption(T.Nothing)}return()=>{let{disabled:s}=n,O={active:S.value,selected:x.value,disabled:s},k={id:t,ref:c,role:"option",tabIndex:s===!0?void 0:-1,"aria-disabled":s===!0?!0:void 0,"aria-selected":x.value,disabled:void 0,onClick:l,onFocus:C,onPointermove:R,onMousemove:R,onPointerleave:o,onMouseleave:o};return F({ourProps:k,theirProps:n,slot:O,attrs:i,slots:m,name:"ComboboxOption"})}}});export{Ae as Combobox,Le as ComboboxButton,Be as ComboboxInput,Fe as ComboboxLabel,He as ComboboxOption,je as ComboboxOptions};
